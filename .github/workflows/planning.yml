name: Planning Workflow

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  planning:
    name: Create Implementation Plan
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'stage:plan')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
      
      - name: Policy gate evaluation
        id: policy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          # Placeholder for policy gate evaluation
          echo "decision=allow" >> $GITHUB_OUTPUT
          echo "Policy gate evaluation: ALLOW (placeholder implementation)"
      
      - name: Add workflow start comment
        if: steps.policy.outputs.decision == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "planning" \
            "started" \
            "Policy gate evaluation passed, beginning implementation planning"
      
      - name: Execute planning analysis
        if: steps.policy.outputs.decision == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          # Placeholder for Claude planning analysis
          echo "Executing planning analysis for issue #${{ steps.context.outputs.issue_id }}"
          
          # Add planning analysis comment (placeholder implementation)
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "planning" \
            "completed" \
            "Implementation plan created (placeholder). Ready for prioritization stage."
      
      - name: Transition to prioritization stage
        if: steps.policy.outputs.decision == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:plan" \
            "stage:prioritize" \
            "planning"
      
      - name: Handle policy block
        if: steps.policy.outputs.decision == 'block'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:plan" \
            "stage:blocked" \
            "planning"
          
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "planning" \
            "blocked" \
            "Policy gate blocked this request. Manual intervention required."