name: Issue Prioritization Workflow

# ONLY trigger on issue label events - never on push/PR
on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  prioritization:
    name: Prioritize Issue
    runs-on: [self-hosted, solops-local]
    if: |
      github.event.label.name == 'stage:prioritize' && 
      github.event.action == 'labeled' &&
      github.event.issue.user.type != 'Bot' &&
      github.repository_owner == github.actor
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
      
      - name: Validate issue context
        run: |
          echo "üîç Validating issue context..."
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue author: ${{ github.event.issue.user.login }}"
          echo "Label added: ${{ github.event.label.name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Actor: ${{ github.actor }}"
          
          # Additional security validation
          if [[ "${{ github.event.issue.user.type }}" == "Bot" ]]; then
            echo "‚ùå Skipping workflow - issue created by bot"
            exit 1
          fi
          
          if [[ "${{ github.event.action }}" != "labeled" ]]; then
            echo "‚ùå Skipping workflow - not a label addition event"
            exit 1
          fi
          
          if [[ "${{ github.event.label.name }}" != "stage:prioritize" ]]; then
            echo "‚ùå Skipping workflow - incorrect label"
            exit 1
          fi
          
          echo "‚úÖ Issue context validation passed"
      
      - name: Policy Gate Evaluation
        id: policy
        env:
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üõ°Ô∏è Evaluating policy gate for prioritization stage..."
          
          policy_json=$(python3 .github/scripts/policy_gate_evaluation.py evaluate \
            --stage=prioritize \
            --issue-id=${{ github.event.issue.number }})
          
          # Parse JSON response using jq
          decision=$(echo "$policy_json" | jq -r '.decision')
          reason=$(echo "$policy_json" | jq -r '.reason')
          constructed_prompt=$(echo "$policy_json" | jq -r '.constructed_prompt // ""')
          
          # Set environment variables for subsequent steps
          echo "POLICY_DECISION=$decision" >> $GITHUB_ENV
          echo "POLICY_REASON=$reason" >> $GITHUB_ENV
          echo "CONSTRUCTED_PROMPT<<EOF" >> $GITHUB_ENV
          echo "$constructed_prompt" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "Policy decision: $decision"
          echo "Policy reason: $reason"
      
      - name: Execute Prioritization with Claude CLI
        id: prioritization
        if: env.POLICY_DECISION == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          CLAUDE_CLIENT_TYPE: cli
          REPO_ROOT: ${{ github.workspace }}
        run: |
          echo "‚öñÔ∏è Starting repository-aware prioritization workflow for issue #${{ github.event.issue.number }}"
          
          python3 .github/scripts/functional_workflow_executor.py prioritization \
            --issue-id=${{ github.event.issue.number }} \
            --prompt="$CONSTRUCTED_PROMPT"
      
      - name: Handle Policy Block
        if: env.POLICY_DECISION == 'block'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Prioritization blocked by policy gate"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "blocked" \
            "Policy gate blocked: $POLICY_REASON"
          
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"
      
      - name: Handle Policy Review Required
        if: env.POLICY_DECISION == 'review_required'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ö†Ô∏è Prioritization requires human review"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "review_required" \
            "Human review required: $POLICY_REASON"
      
      - name: Apply priority label and transition
        if: steps.prioritization.outputs.success == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          # Add priority label using GitHub API directly
          PRIORITY_LABEL="${{ steps.prioritization.outputs.recommended_priority }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d "{\"labels\": [\"$PRIORITY_LABEL\"]}"
          
          # Transition to awaiting implementation approval
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:awaiting-implementation-approval" \
            "prioritization"
      
      - name: Handle blocked prioritization
        if: steps.prioritization.outputs.blocked == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "blocked" \
            "Prioritization analysis blocked: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle review required
        if: steps.prioritization.outputs.review_required == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "review_required" \
            "Human review required: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle prioritization failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Prioritization workflow failed - adding detailed error comment to issue"
          
          # Create detailed error comment
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "failed" \
            "Prioritization Workflow Failed - Repository-aware workflow execution failed during priority assessment. Check GitHub Actions logs for details. Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Transition to blocked state
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"