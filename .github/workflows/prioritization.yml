name: Issue Prioritization Workflow

# ONLY trigger on issue label events - never on push/PR
on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  prioritization:
    name: Prioritize Issue
    runs-on: [self-hosted, solops-local]
    if: |
      github.event.label.name == 'stage:prioritize' && 
      github.event.action == 'labeled' &&
      github.event.issue.user.type != 'Bot' &&
      (github.repository_owner == github.actor || github.actor == 'github-actions[bot]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Python dependencies
        run: |
          echo "üì¶ Installing Python dependencies for runner environment..."
          echo "Python version: $(python3 --version)"
          echo "Python path: $(which python3)"
          echo "Architecture: $(uname -m)"
          echo "Current working directory: $(pwd)"
          echo "PYTHONPATH will be: ${{ github.workspace }}/app:${{ github.workspace }}"
          
          # Try to import pydantic first to see current state
          echo "Testing current pydantic installation..."
          python3 -c "import pydantic; print('Current pydantic version:', pydantic.__version__)" || echo "Pydantic not available or broken"
          
          # Install dependencies
          python3 -m pip install --user -r requirements.txt --force-reinstall --no-cache-dir
          
          # Verify installation
          echo "Verifying pydantic installation..."
          python3 -c "import pydantic; print('Installed pydantic version:', pydantic.__version__)"
          echo "‚úÖ Dependencies installed successfully"
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
      
      - name: Validate issue context
        run: |
          echo "üîç Validating issue context..."
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue author: ${{ github.event.issue.user.login }}"
          echo "Label added: ${{ github.event.label.name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Actor: ${{ github.actor }}"
          
          # Additional security validation
          if [[ "${{ github.event.issue.user.type }}" == "Bot" ]]; then
            echo "‚ùå Skipping workflow - issue created by bot"
            exit 1
          fi
          
          if [[ "${{ github.event.action }}" != "labeled" ]]; then
            echo "‚ùå Skipping workflow - not a label addition event"
            exit 1
          fi
          
          if [[ "${{ github.event.label.name }}" != "stage:prioritize" ]]; then
            echo "‚ùå Skipping workflow - incorrect label"
            exit 1
          fi
          
          echo "‚úÖ Issue context validation passed"
      
      - name: Policy Gate Evaluation
        id: policy
        env:
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üõ°Ô∏è Evaluating policy gate for prioritization stage..."
          echo "üîç Environment:"
          echo "  PYTHONPATH: $PYTHONPATH"
          echo "  Working directory: $(pwd)"
          echo "  Issue ID: ${{ github.event.issue.number }}"
          
          # Run policy gate and capture both stdout and stderr
          echo "üöÄ Running policy gate evaluation..."
          set +e  # Don't exit immediately on error
          python3 -u .github/scripts/policy_gate_evaluation.py evaluate-stage \
            --stage=prioritize \
            --issue-id=${{ github.event.issue.number }} \
            --output-format=json > policy_stdout.log 2> policy_stderr.log
          exit_code=$?
          set -e
          
          echo "üìã Policy gate exit code: $exit_code"
          
          # Always show what we captured
          echo "=== STDOUT ==="
          cat policy_stdout.log || echo "(empty)"
          
          echo ""
          echo "=== STDERR ==="
          cat policy_stderr.log || echo "(empty)"
          
          # Check if it failed
          if [ $exit_code -ne 0 ]; then
            echo ""
            echo "‚ùå Policy gate evaluation FAILED with exit code $exit_code"
            echo "Setting policy decision to 'block' due to evaluation error"
            
            # Capture error details for the issue comment
            error_details=$(cat policy_stderr.log 2>/dev/null || echo "No error details available")
            
            echo "POLICY_DECISION=block" >> $GITHUB_ENV
            echo "POLICY_REASON=Policy evaluation script failed: $error_details" >> $GITHUB_ENV
            echo "CONSTRUCTED_PROMPT=" >> $GITHUB_ENV
            
            exit 1
          fi
          
          # Extract JSON from stdout
          policy_json=$(cat policy_stdout.log)
          
          if [ -z "$policy_json" ]; then
            echo "‚ùå No output from policy gate"
            exit 1
          fi
          
          echo ""
          echo "üìã Policy JSON:"
          echo "$policy_json"
          
          # Parse JSON response using jq
          decision=$(echo "$policy_json" | jq -r '.decision')
          reason=$(echo "$policy_json" | jq -r '.reason')
          constructed_prompt=$(echo "$policy_json" | jq -r '.constructed_prompt // ""')
          
          # Set environment variables for subsequent steps
          echo "POLICY_DECISION=$decision" >> $GITHUB_ENV
          echo "POLICY_REASON=$reason" >> $GITHUB_ENV
          echo "CONSTRUCTED_PROMPT<<EOF" >> $GITHUB_ENV
          echo "$constructed_prompt" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo ""
          echo "‚úÖ Policy decision: $decision"
          echo "‚úÖ Policy reason: $reason"
          echo "‚úÖ Prompt length: ${#constructed_prompt} characters"
      
      - name: Execute Prioritization with Claude CLI
        id: prioritization
        if: env.POLICY_DECISION == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          CLAUDE_CLIENT_TYPE: cli
          REPO_ROOT: ${{ github.workspace }}
          CLAUDE_CODE_SESSION_ACCESS_TOKEN: ${{ secrets.CLAUDE_CODE_SESSION_ACCESS_TOKEN }}
        run: |
          echo "‚öñÔ∏è Starting repository-aware prioritization workflow for issue #${{ github.event.issue.number }}"
          echo "üîç Environment check:"
          echo "  PYTHONPATH: $PYTHONPATH"
          echo "  REPO_ROOT: $REPO_ROOT"
          echo "  CLAUDE_CLIENT_TYPE: $CLAUDE_CLIENT_TYPE"
          echo "  Python version: $(python3 --version)"
          
          # Test imports before running
          echo "üß™ Testing Python imports..."
          python3 -c "import sys; print('Python path:', sys.path)" || echo "Failed to check Python path"
          python3 -c "from workflow_engine import WorkflowEngine; print('‚úÖ WorkflowEngine imported')" || echo "‚ùå Failed to import WorkflowEngine"
          python3 -c "from claude_client_factory import get_claude_client; print('‚úÖ Claude client factory imported')" || echo "‚ùå Failed to import claude_client_factory"
          
          echo "üöÄ Executing prioritization workflow..."
          set -e  # Exit on error
          python3 .github/scripts/functional_workflow_executor.py prioritization \
            --issue-id=${{ github.event.issue.number }} \
            --prompt="$CONSTRUCTED_PROMPT" 2>&1 | tee prioritization_output.log
          
          echo "‚úÖ Prioritization workflow execution completed"
      
      - name: Handle Policy Block
        if: env.POLICY_DECISION == 'block'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Prioritization blocked by policy gate"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "blocked" \
            "Policy gate blocked: $POLICY_REASON"
          
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"
      
      - name: Handle Policy Review Required
        if: env.POLICY_DECISION == 'review_required'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ö†Ô∏è Prioritization requires human review"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "review_required" \
            "Human review required: $POLICY_REASON"
      
      - name: Apply priority label and transition
        if: steps.prioritization.outputs.success == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          # Add priority label using GitHub API directly
          PRIORITY_LABEL="${{ steps.prioritization.outputs.recommended_priority }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d "{\"labels\": [\"$PRIORITY_LABEL\"]}"
          
          # Add approval instructions comment
          python3 -c "
          import os
          import requests
          
          comment = '''## üéØ Ready for Implementation
          
          The triage, planning, and prioritization stages are complete. This issue is now awaiting implementation approval.
          
          ### üìã Summary
          - **Priority**: $PRIORITY_LABEL
          - **Stage**: Awaiting Implementation Approval
          
          ### ‚úÖ To Approve Implementation
          Comment on this issue with one of the following:
          - \`approve implementation\`
          - \`/approve\`
          - \`approved\`
          
          Once approved, the implementation workflow will automatically begin.
          
          ### ‚ùå To Reject or Defer
          - Remove the \`stage:awaiting-implementation-approval\` label
          - Add the \`stage:blocked\` label
          - Add a comment explaining why
          '''
          
          url = f\"https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments\"
          headers = {
              'Authorization': f\"token {os.environ['GITHUB_TOKEN']}\",
              'Accept': 'application/vnd.github.v3+json'
          }
          data = {'body': comment}
          
          response = requests.post(url, headers=headers, json=data)
          if response.status_code == 201:
              print('‚úÖ Added approval instructions comment')
          else:
              print(f'‚ö†Ô∏è Failed to add comment: {response.status_code}')
          "
          
          # Transition to awaiting implementation approval
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:awaiting-implementation-approval" \
            "prioritization"
      
      - name: Handle blocked prioritization
        if: steps.prioritization.outputs.blocked == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "blocked" \
            "Prioritization analysis blocked: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle review required
        if: steps.prioritization.outputs.review_required == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "review_required" \
            "Human review required: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle prioritization failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Prioritization workflow failed - adding detailed error comment to issue"
          
          # Capture any available logs
          ERROR_DETAILS="Prioritization Workflow Failed - Repository-aware workflow execution failed during priority assessment."
          
          if [ -f prioritization_output.log ]; then
            echo "üìã Prioritization output log found:"
            cat prioritization_output.log
            ERROR_DETAILS="$ERROR_DETAILS\n\nLast output:\n\`\`\`\n$(tail -20 prioritization_output.log)\n\`\`\`"
          else
            echo "‚ö†Ô∏è No prioritization output log found"
          fi
          
          # Create detailed error comment
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "prioritization" \
            "failed" \
            "$ERROR_DETAILS\n\nCheck GitHub Actions logs for details. Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Transition to blocked state
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"