name: Issue Prioritization Workflow

# ONLY trigger on issue label events - never on push/PR
on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  prioritization:
    name: Prioritize Issue
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'stage:prioritize') && github.event.action == 'labeled'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
      
      - name: Validate issue context
        run: |
          echo "üîç Validating issue context..."
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue author: ${{ github.event.issue.user.login }}"
          echo "Label added: ${{ github.event.label.name }}"
          echo "Action: ${{ github.event.action }}"
          
          # Prevent workflow from running on issues created by bots or automation
          if [[ "${{ github.event.issue.user.type }}" == "Bot" ]]; then
            echo "‚ùå Skipping workflow - issue created by bot"
            exit 1
          fi
          
          # Ensure this is actually a label addition event
          if [[ "${{ github.event.action }}" != "labeled" ]]; then
            echo "‚ùå Skipping workflow - not a label addition event"
            exit 1
          fi
          
          echo "‚úÖ Issue context validation passed"
      
      - name: Validate environment variables
        run: |
          if [ -z "${{ secrets.CLAUDE_API_KEY }}" ]; then
            echo "‚ùå CLAUDE_API_KEY is not configured in repository secrets"
            echo "üí° Add your Claude API key to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ Environment variables validated"
      
      - name: Execute functional prioritization workflow
        id: prioritization
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚öñÔ∏è Starting functional prioritization workflow for issue #${{ steps.context.outputs.issue_id }}"
          python .github/scripts/functional_workflow_executor.py prioritization \
            --issue-id ${{ steps.context.outputs.issue_id }}
      
      - name: Apply priority label and transition
        if: steps.prioritization.outputs.success == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          # Add priority label using GitHub API directly
          PRIORITY_LABEL="${{ steps.prioritization.outputs.recommended_priority }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.context.outputs.issue_id }}/labels" \
            -d "{\"labels\": [\"$PRIORITY_LABEL\"]}"
          
          # Transition to awaiting implementation approval
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:prioritize" \
            "stage:awaiting-implementation-approval" \
            "prioritization"
      
      - name: Handle blocked prioritization
        if: steps.prioritization.outputs.blocked == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"
          
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "prioritization" \
            "blocked" \
            "Policy gate blocked this request: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle review required
        if: steps.prioritization.outputs.review_required == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "prioritization" \
            "blocked" \
            "Human review required: ${{ steps.prioritization.outputs.reason }}"
      
      - name: Handle prioritization failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Prioritization workflow failed - adding detailed error comment to issue"
          
          # Create detailed error comment
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "prioritization" \
            "failed" \
            "Prioritization Workflow Failed - Workflow execution failed during priority assessment. Check GitHub Actions logs for details. Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Transition to blocked state
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:prioritize" \
            "stage:blocked" \
            "prioritization"