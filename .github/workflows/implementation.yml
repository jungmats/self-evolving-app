name: Implementation Workflow

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  implementation:
    name: Implement Solution
    runs-on: [self-hosted, solops-local]
    if: |
      github.event.label.name == 'stage:implement' && 
      github.event.action == 'labeled' &&
      github.event.issue.user.type != 'Bot' &&
      (github.repository_owner == github.actor || github.actor == 'github-actions[bot]')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "branch_name=implement-issue-${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Validate issue context
        run: |
          echo "üîç Validating issue context..."
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue author: ${{ github.event.issue.user.login }}"
          echo "Label added: ${{ github.event.label.name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Actor: ${{ github.actor }}"
          
          # Additional security validation
          if [[ "${{ github.event.issue.user.type }}" == "Bot" ]]; then
            echo "‚ùå Skipping workflow - issue created by bot"
            exit 1
          fi
          
          if [[ "${{ github.event.action }}" != "labeled" ]]; then
            echo "‚ùå Skipping workflow - not a label addition event"
            exit 1
          fi
          
          if [[ "${{ github.event.label.name }}" != "stage:implement" ]]; then
            echo "‚ùå Skipping workflow - incorrect label"
            exit 1
          fi
          
          echo "‚úÖ Issue context validation passed"
      
      - name: Policy Gate Evaluation
        id: policy
        env:
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "üõ°Ô∏è Evaluating policy gate for implementation stage..."
          echo "üîç Environment:"
          echo "  PYTHONPATH: $PYTHONPATH"
          echo "  Working directory: $(pwd)"
          echo "  Issue ID: ${{ github.event.issue.number }}"
          
          # Run policy gate and capture both stdout and stderr
          echo "üöÄ Running policy gate evaluation..."
          set +e  # Don't exit immediately on error
          python3 -u .github/scripts/policy_gate_evaluation.py evaluate-stage \
            --stage=implement \
            --issue-id=${{ github.event.issue.number }} \
            --output-format=json > policy_stdout.log 2> policy_stderr.log
          exit_code=$?
          set -e
          
          echo "üìã Policy gate exit code: $exit_code"
          
          # Always show what we captured
          echo "=== STDOUT ==="
          cat policy_stdout.log || echo "(empty)"
          
          echo ""
          echo "=== STDERR ==="
          cat policy_stderr.log || echo "(empty)"
          
          # Check if it failed
          if [ $exit_code -ne 0 ]; then
            echo ""
            echo "‚ùå Policy gate evaluation FAILED with exit code $exit_code"
            echo "Setting policy decision to 'block' due to evaluation error"
            
            # Capture error details for the issue comment
            error_details=$(cat policy_stderr.log 2>/dev/null || echo "No error details available")
            
            echo "POLICY_DECISION=block" >> $GITHUB_ENV
            echo "POLICY_REASON=Policy evaluation script failed: $error_details" >> $GITHUB_ENV
            echo "CONSTRUCTED_PROMPT=" >> $GITHUB_ENV
            
            exit 1
          fi
          
          # Extract JSON from stdout
          policy_json=$(cat policy_stdout.log)
          
          if [ -z "$policy_json" ]; then
            echo "‚ùå No output from policy gate"
            exit 1
          fi
          
          echo ""
          echo "üìã Policy JSON:"
          echo "$policy_json"
          
          # Parse JSON response using jq
          decision=$(echo "$policy_json" | jq -r '.decision')
          reason=$(echo "$policy_json" | jq -r '.reason')
          constructed_prompt=$(echo "$policy_json" | jq -r '.constructed_prompt // ""')
          
          # Set environment variables for subsequent steps
          echo "POLICY_DECISION=$decision" >> $GITHUB_ENV
          echo "POLICY_REASON=$reason" >> $GITHUB_ENV
          echo "CONSTRUCTED_PROMPT<<EOF" >> $GITHUB_ENV
          echo "$constructed_prompt" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo ""
          echo "‚úÖ Policy decision: $decision"
          echo "‚úÖ Policy reason: $reason"
          echo "‚úÖ Prompt length: ${#constructed_prompt} characters"
      
      - name: Handle Policy Block
        if: env.POLICY_DECISION == 'block'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Implementation blocked by policy gate"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "implementation" \
            "blocked" \
            "Policy gate blocked: $POLICY_REASON"
          
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:implement" \
            "stage:blocked" \
            "implementation"
      
      - name: Handle Policy Review Required
        if: env.POLICY_DECISION == 'review_required'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ö†Ô∏è Implementation requires human review"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "implementation" \
            "review_required" \
            "Human review required: $POLICY_REASON"
      
      - name: Create implementation branch
        if: env.POLICY_DECISION == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "üåø Creating implementation branch..."
          
          git config --global user.name "Claude Implementation Bot"
          git config --global user.email "claude-bot@example.com"
          
          # Configure git to use the PAT token for authentication
          git config --global url."https://$GITHUB_TOKEN@github.com/".insteadOf "https://github.com/"
          
          # Verify we're on the right commit
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current branch: $(git branch --show-current)"
          
          # Create and checkout new branch
          git checkout -b ${{ steps.context.outputs.branch_name }}
          
          echo "‚úÖ Branch created: ${{ steps.context.outputs.branch_name }}"
          echo "Current branch: $(git branch --show-current)"
      
      - name: Execute Implementation with Claude CLI
        if: env.POLICY_DECISION == 'allow'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          CLAUDE_CLIENT_TYPE: cli
          REPO_ROOT: ${{ github.workspace }}
          CLAUDE_CODE_SESSION_ACCESS_TOKEN: ${{ secrets.CLAUDE_CODE_SESSION_ACCESS_TOKEN }}
        run: |
          echo "üîß Starting repository-aware implementation for issue #${{ github.event.issue.number }}"
          
          # Execute Claude CLI implementation with repository context
          python3 .github/scripts/functional_workflow_executor.py implementation \
            --issue-id=${{ github.event.issue.number }} \
            --prompt="$CONSTRUCTED_PROMPT" 2>&1 | tee implementation_output.log
          
          echo "‚úÖ Implementation generation completed"
          
          # Check git status
          echo "üìã Git status:"
          git status
          
          # Check if any files were modified
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ö†Ô∏è No files were modified by implementation"
            echo "Creating placeholder to demonstrate workflow"
            mkdir -p implementation
            echo "# Implementation for Issue #${{ github.event.issue.number }}" > implementation/README.md
            git add implementation/README.md
          else
            echo "‚úÖ Files modified by implementation:"
            git diff --name-only
            git diff --cached --name-only
            git add -A
          fi
          
          # Verify files are staged
          echo "üìã Staged files:"
          git diff --cached --name-only
          
          # Commit changes
          git commit -m "$(cat <<'EOF'
          Implementation for issue #${{ github.event.issue.number }}

          Generated with Claude CLI for enhanced context awareness.

          Trace_ID: ${{ github.event.issue.number }}-${{ github.run_id }}
          EOF
          )"
          
          echo "‚úÖ Changes committed"
          echo "üìã Commit info:"
          git log -1 --oneline
      
      - name: Generate unit tests
        if: env.POLICY_DECISION == 'allow'
        env:
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
          CLAUDE_CLIENT_TYPE: cli
          REPO_ROOT: ${{ github.workspace }}
          CLAUDE_CODE_SESSION_ACCESS_TOKEN: ${{ secrets.CLAUDE_CODE_SESSION_ACCESS_TOKEN }}
        run: |
          echo "üß™ Generating unit tests for implementation..."
          
          # For now, verify existing tests still pass
          # In full implementation, Claude CLI would generate tests for new code
          echo "‚úÖ Unit test generation completed (placeholder)"
      
      - name: Run tests
        if: env.POLICY_DECISION == 'allow'
        continue-on-error: true
        id: tests
        run: |
          echo "üß™ Running test suite..."
          
          # Run Python tests
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            echo "Running pytest..."
            python3 -m pytest tests/ -v --tb=short 2>&1 | tee test_output.log || echo "test_failed=true" >> $GITHUB_ENV
          else
            echo "No Python tests found"
          fi
          
          # Check test results
          if [ "$test_failed" = "true" ]; then
            echo "‚ùå Tests failed"
            exit 1
          else
            echo "‚úÖ All tests passed"
          fi
      
      - name: Push implementation branch
        if: env.POLICY_DECISION == 'allow' && steps.tests.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "üì§ Pushing implementation branch..."
          echo "Branch: ${{ steps.context.outputs.branch_name }}"
          echo "Current branch: $(git branch --show-current)"
          echo "Remote: $(git remote -v)"
          
          # Verify we have commits to push
          echo "üìã Commits on this branch:"
          git log --oneline -5
          
          # Push the branch (git is already configured to use PAT token)
          echo "Pushing to origin/${{ steps.context.outputs.branch_name }}..."
          git push -v origin ${{ steps.context.outputs.branch_name }}
          
          echo "‚úÖ Branch pushed successfully"
      
      - name: Create pull request
        if: env.POLICY_DECISION == 'allow' && steps.tests.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "üìù Creating Pull Request..."
          
          # Use PR manager script to create PR with proper Trace_ID and Issue linking
          python3 .github/scripts/pr_manager.py create \
            --issue-id=${{ github.event.issue.number }} \
            --branch=${{ steps.context.outputs.branch_name }} \
            --base=main
          
          echo "‚úÖ Pull Request created successfully"
      
      - name: Transition to PR opened stage
        if: env.POLICY_DECISION == 'allow' && steps.tests.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          # Transition to PR opened stage
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:implement" \
            "stage:pr-opened" \
            "implementation"
          
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "implementation" \
            "completed" \
            "Implementation completed successfully. Pull Request created and ready for review."
      
      - name: Handle test failures
        if: env.POLICY_DECISION == 'allow' && steps.tests.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Tests failed - blocking PR creation"
          
          # Extract test failure details
          TEST_FAILURES="Test execution failed. See workflow logs for details."
          if [ -f test_output.log ]; then
            TEST_FAILURES=$(tail -50 test_output.log)
          fi
          
          # Add comment with test failure details
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "implementation" \
            "test_failed" \
            "Implementation generated but tests failed:\n\n\`\`\`\n${TEST_FAILURES}\n\`\`\`\n\nPR creation blocked until tests pass."
          
          # Transition to blocked state
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:implement" \
            "stage:blocked" \
            "implementation"
      
      - name: Handle implementation failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/app:${{ github.workspace }}
        run: |
          echo "‚ùå Implementation workflow failed - adding detailed error comment to issue"
          
          # Create detailed error comment
          python3 .github/scripts/workflow_transition.py progress \
            ${{ github.event.issue.number }} \
            "implementation" \
            "failed" \
            "Implementation Workflow Failed - Repository-aware workflow execution failed during code generation. Check GitHub Actions logs for details. Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Transition to blocked state
          python3 .github/scripts/workflow_transition.py transition \
            ${{ github.event.issue.number }} \
            "stage:implement" \
            "stage:blocked" \
            "implementation"