name: Triage Workflow

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  triage:
    name: Triage Issue
    runs-on: ubuntu-latest
    if: contains(github.event.label.name, 'stage:triage')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract issue context
        id: context
        run: |
          echo "issue_id=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
      
      - name: Validate environment variables
        run: |
          if [ -z "${{ secrets.CLAUDE_API_KEY }}" ]; then
            echo "‚ùå CLAUDE_API_KEY is not configured in repository secrets"
            echo "üí° Add your Claude API key to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ Environment variables validated"
      
      - name: Execute functional triage workflow
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "üîç Starting functional triage workflow for issue #${{ steps.context.outputs.issue_id }}"
          python .github/scripts/functional_workflow_executor.py triage \
            --issue-id ${{ steps.context.outputs.issue_id }}
      
      - name: Handle successful triage
        if: steps.triage.outputs.success == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Transition to next stage based on triage results
          NEXT_STAGE="${{ steps.triage.outputs.next_stage }}"
          
          if [ "$NEXT_STAGE" = "plan" ]; then
            python .github/scripts/workflow_transition.py transition \
              ${{ steps.context.outputs.issue_id }} \
              "stage:triage" \
              "stage:plan" \
              "triage"
          elif [ "$NEXT_STAGE" = "blocked" ]; then
            python .github/scripts/workflow_transition.py transition \
              ${{ steps.context.outputs.issue_id }} \
              "stage:triage" \
              "stage:blocked" \
              "triage"
          else
            echo "Unknown next stage: $NEXT_STAGE"
            exit 1
          fi
      
      - name: Handle blocked triage
        if: steps.triage.outputs.blocked == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:triage" \
            "stage:blocked" \
            "triage"
          
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "triage" \
            "blocked" \
            "Policy gate blocked this request: ${{ steps.triage.outputs.reason }}"
      
      - name: Handle review required
        if: steps.triage.outputs.review_required == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "triage" \
            "blocked" \
            "Human review required: ${{ steps.triage.outputs.reason }}"
      
      - name: Handle triage failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ùå Triage workflow failed - adding detailed error comment to issue"
          
          # Create detailed error comment
          python .github/scripts/workflow_transition.py progress \
            ${{ steps.context.outputs.issue_id }} \
            "triage" \
            "failed" \
            "‚ùå **Triage Workflow Failed**

**Error**: Workflow execution failed during triage analysis
**Possible Causes**:
- Claude API authentication issues
- Missing environment variables
- Network connectivity problems
- Policy gate evaluation errors

**Troubleshooting**:
1. Check that CLAUDE_API_KEY is configured in repository secrets
2. Verify GitHub Actions logs for detailed error messages
3. Ensure all dependencies are properly installed

**Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

This issue has been moved to **stage:blocked** and requires manual intervention."
          
          # Transition to blocked state
          python .github/scripts/workflow_transition.py transition \
            ${{ steps.context.outputs.issue_id }} \
            "stage:triage" \
            "stage:blocked" \
            "triage"